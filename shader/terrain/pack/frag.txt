#version 120
uniform sampler2D tex_normalmap,tex_rock_sand_grass,tex_heightmap;uniform vec4 scale,sunlightvec;uniform float snowfall;varying vec3 a;varying vec4 b;vec4 y(sampler2D c,vec2 d){vec2 e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;e=vec2(4096);f=vec2(1./e.x,1./e.y);g=d*e-vec2(.5);h=g-floor(g);i=1.-h;j=i*i;k=h*h;l=1./6.*j*i;m=2./3.-.5*k*(2.-h);n=2./3.-.5*j*(2.-i);o=1./6.*k*h;p=l+m;q=n+o;r=g-h;s=(m/p-.5+r)*f;t=(o/q+1.5+r)*f;vec4 u,v,w,x;u=texture2D(c,vec2(s.x,s.y));v=texture2D(c,vec2(s.x,t.y));u=mix(v,u,p.y);w=texture2D(c,vec2(t.x,s.y));x=texture2D(c,vec2(t.x,t.y));w=mix(x,w,p.y);return mix(w,u,p.x);}void main(){vec4 c,g,l,m,n,o,p,r;if(scale.x<1./64.)c=y(tex_normalmap,a.xy);else c=texture2D(tex_normalmap,a.xy);float d,e,f,h,i,j,k,q;d=clamp(c.z*2.-1.,0.,1.);e=a.z;f=1.-clamp(b.z*32.,0.,1.);g=texture2D(tex_rock_sand_grass,a.xy*16.);h=1.;if(d>.01)h=texture2D(tex_rock_sand_grass,a.xy*1024.).w;if(f>.01){f=min(.5,f);vec4 i=texture2D(tex_rock_sand_grass,a.xy*32.);g=mix(g,i,f);float j=1.-clamp(b.z*128.,0.,1.);if(j>.01){j=min(.5,j);vec4 i=texture2D(tex_rock_sand_grass,a.xy*256.);g=mix(g,i,j);}}c.xy+=(texture2D(tex_normalmap,a.xy*64.).xy-.5)*c.w;c.xy=(c.xy-.5)*(128./32.);c.xyz=normalize(cross(vec3(1,0,c.x),vec3(0,1,c.y)));i=clamp((c.z*.5-e)*2.,0.,1.);j=clamp((c.z*.5-e)*8.,0.,1.);k=clamp((c.z-.5-clamp((snowfall-e)*3.,0,.5))*32.,0.,1.);l=g.x*vec4(1);m=g.y*vec4(.7,.4,0,0);n=g.z*vec4(.4,.6,.2,0);o=vec4(1.1,1.1,1.1,0);p=l;m=mix(m,n,i);p=mix(p,m,j);p=mix(p,o,k);q=dot(c.xyz,sunlightvec.xzy);r.z=clamp(q,0.,1.);r.z=(r.y=r.z*r.z);r.x=q>0?r.z:q*q*2.;p=p*r;gl_FragColor=mix(p,vec4(201./255.,224./255.,245./255.,1),clamp(b.z*1.4-.2,0,.8));}