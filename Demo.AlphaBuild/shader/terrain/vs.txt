#version 120
uniform sampler2D tex_heightmap,tex_rock_sand_grass,tex_normalmap;uniform vec4 map_position,offset,scale;uniform float heightmap_avg;varying vec3 a;varying vec4 b;vec4 y(sampler2D c,vec2 d){vec2 e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;e=vec2(4096);f=vec2(1./e.x,1./e.y);g=d*e-vec2(.5);h=g-floor(g);i=1.-h;j=i*i;k=h*h;l=1./6.*j*i;m=2./3.-.5*k*(2.-h);n=2./3.-.5*j*(2.-i);o=1./6.*k*h;p=l+m;q=n+o;r=g-h;s=(m/p-.5+r)*f;t=(o/q+1.5+r)*f;vec4 u,v,w,x;u=texture2D(c,vec2(s.x,s.y))*16.;v=texture2D(c,vec2(s.x,t.y))*16.;u=mix(v,u,p.y);w=texture2D(c,vec2(t.x,s.y))*16.;x=texture2D(c,vec2(t.x,t.y))*16.;w=mix(x,w,p.y);return mix(w,u,p.x)*(1./16.);}float z(float c[16],float d,int e){return c[e+1]+.5*d*(c[e+2]-c[e+0]+d*(2.*c[e+0]-5.*c[e+1]+4.*c[e+2]-c[e+3]+d*(3.*(c[e+1]-c[e+2])+c[e+3]-c[e+0])));}float A(sampler2D c,vec2 d){vec2 e,f,g,h;e=vec2(4096);f=floor(d*e);g=d*e-floor(d*e);h=vec2(1./e.x,1./e.y);f=f/e;float i[16],l[16];for(int j=0;j<4;j++)for(int k=0;k<4;k++)i[j*4+k]=texture2D(c,f+vec2(float(j-1)*h.x,float(k-1)*h.y)).x;l[0]=z(i,g.y,0);l[1]=z(i,g.y,4);l[2]=z(i,g.y,8);l[3]=z(i,g.y,12);return z(l,g.x,0);}void main(){vec4 c,d;c=scale*(offset+vec4(gl_Vertex.xyz,1));c.z=-c.z;d=c*2.+map_position;float e=1.;if(scale.x<1./128.){if(scale.x<1./256.)c.z+=A(tex_heightmap,d.xy-floor(d.xy));else c.z+=y(tex_heightmap,d.xy-floor(d.xy)).x;e=y(tex_normalmap,d.xy).w;}else{c.z+=texture2D(tex_heightmap,d.xy).x;e=texture2D(tex_normalmap,d.xy).w;}c.z+=(texture2D(tex_heightmap,d.xy*64.).x-heightmap_avg)*.01*e;a.z=c.z;a.xy=d.xy;c.z*=-.05;gl_Position=(b=gl_ModelViewProjectionMatrix*c);b/=8192.*64.;}